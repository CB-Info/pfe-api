# üß™ Cahier de Recettes - Eatopia API (C2.3.1)

## 1. Objectif et p√©rim√®tre

### Objectif du document
Ce cahier de recettes constitue le **document de validation fonctionnelle** (C2.3.1) de l'API Eatopia. Il d√©finit les sc√©narios de test pour valider le bon fonctionnement de chaque fonctionnalit√© avant mise en production.

### P√©rim√®tre de validation
- **API REST compl√®te** - Tous les endpoints de l'ERP restaurant
- **Syst√®me d'authentification** - Firebase Auth + JWT tokens
- **Gestion des r√¥les RBAC** - 6 niveaux hi√©rarchiques
- **Modules m√©tier** - Cards, Dishes, Ingredients, Orders, Stock, Tables, Users
- **S√©curit√© applicative** - Validation, autorisation, gestion d'erreurs

### Crit√®res de recette
‚úÖ **Fonctionnel** - Toutes les fonctionnalit√©s r√©pondent aux sp√©cifications
‚úÖ **S√©curis√©** - Authentification et autorisations respect√©es
‚úÖ **Robuste** - Gestion d'erreurs et cas limites ma√Ætris√©s
‚úÖ **Performant** - Temps de r√©ponse < 2s pour les requ√™tes simples

---

## 2. Pr√©requis techniques

### Environnement de test
- **Base URL** : `http://localhost:3000`
- **Documentation** : `http://localhost:3000/api` (Swagger)
- **Base de donn√©es** : MongoDB avec donn√©es de test
- **Authentification** : Firebase configur√© avec comptes de test

### Donn√©es de r√©f√©rence (Fixtures)
```bash
# Charger les donn√©es de test
npm run load-fixtures
```

**Contenu g√©n√©r√©** :
- 20 ingr√©dients avec noms al√©atoires
- 10 plats avec ingr√©dients, prix, descriptions
- Cat√©gories : STARTERS, MAIN_DISHES, DESSERTS, etc.

### Comptes utilisateurs de test

| R√¥le | Email | Password | Permissions |
|------|-------|----------|-------------|
| **ADMIN** | admin@eatopia.com | AdminPass123! | Acc√®s complet syst√®me |
| **OWNER** | owner@eatopia.com | OwnerPass123! | Supervision restaurant |
| **MANAGER** | manager@eatopia.com | ManagerPass123! | Gestion op√©rationnelle |
| **KITCHEN_STAFF** | chef@eatopia.com | ChefPass123! | Pr√©paration commandes |
| **WAITER** | waiter@eatopia.com | WaiterPass123! | Prise de commandes |
| **CUSTOMER** | customer@eatopia.com | CustomerPass123! | Commandes uniquement |

---

## 3. Sc√©narios de recette par th√®me

### üîê **TH√àME 1 : Authentification et autorisations**

#### **Sc√©nario AUTH-001 : Connexion r√©ussie**

**Pr√©-√©tat** : Utilisateur non connect√©, compte valide existant

**√âtapes API** :
```http
POST /users/login
Content-Type: application/json

{
  "email": "manager@eatopia.com",
  "password": "ManagerPass123!"
}
```

**R√©sultat attendu** :
```json
{
  "error": "",
  "data": {
    "user": {
      "_id": "...",
      "email": "manager@eatopia.com",
      "firstname": "...",
      "lastname": "...",
      "role": "manager"
    },
    "token": "eyJhbGciOiJSUzI1NiIs...",
    "message": "‚úÖ Connexion r√©ussie !"
  }
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `200 OK`
- Token JWT valide retourn√©
- Informations utilisateur compl√®tes
- Pas d'exposition du mot de passe

#### **Sc√©nario AUTH-002 : Connexion √©chou√©e - Identifiants invalides**

**Pr√©-√©tat** : Utilisateur non connect√©

**√âtapes API** :
```http
POST /users/login
Content-Type: application/json

{
  "email": "wrong@email.com",
  "password": "WrongPassword123!"
}
```

**R√©sultat attendu** :
```json
{
  "statusCode": 401,
  "message": "Email/mot de passe invalide ou compte d√©sactiv√©",
  "error": "Unauthorized"
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `401 Unauthorized`
- Message d'erreur explicite
- Aucune information sensible expos√©e

#### **Sc√©nario AUTH-003 : V√©rification des permissions utilisateur**

**Pr√©-√©tat** : Utilisateur connect√© avec r√¥le MANAGER

**√âtapes API** :
```http
GET /users/permissions/check
Authorization: Bearer {token_manager}
```

**R√©sultat attendu** :
```json
{
  "error": "",
  "data": {
    "role": "manager",
    "canManageUsers": true,
    "canChangeRoles": true,
    "canDeleteUsers": false,
    "canCreateOwners": false,
    "canManageOrders": true,
    "canTakeOrders": true,
    "canPrepareOrders": true,
    "canSuperviseRestaurant": false,
    "roleDescription": "Can change user roles (except admin/owner), activate/deactivate users, and manage restaurant operations"
  }
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `200 OK`
- Permissions correctes selon hi√©rarchie
- Description du r√¥le pr√©cise

---

### üìã **TH√àME 2 : Gestion des menus (Cards)**

#### **Sc√©nario CARD-001 : Consultation des menus (acc√®s libre)**

**Pr√©-√©tat** : Utilisateur connect√© (n'importe quel r√¥le)

**√âtapes API** :
```http
GET /cards
Authorization: Bearer {token}
```

**R√©sultat attendu** :
```json
{
  "error": "",
  "data": [
    {
      "_id": "...",
      "name": "Menu Principal",
      "dishesId": ["dish1", "dish2"],
      "isActive": true,
      "dateOfCreation": "..."
    }
  ]
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `200 OK`
- Structure CardResponseDTO respect√©e
- Tous les menus actifs list√©s
- Performances < 1s

#### **Sc√©nario CARD-002 : Cr√©ation de menu (acc√®s restreint)**

**Pr√©-√©tat** : Utilisateur connect√© avec r√¥le MANAGER ou sup√©rieur

**√âtapes API** :
```http
POST /cards
Authorization: Bearer {token_manager}
Content-Type: application/json

{
  "name": "Menu Hiver 2025",
  "dishesId": ["dish_id_1", "dish_id_2"],
  "isActive": true
}
```

**R√©sultat attendu** :
```json
{
  "error": "",
  "data": {
    "_id": "new_menu_id",
    "name": "Menu Hiver 2025",
    "dishesId": ["dish_id_1", "dish_id_2"],
    "isActive": true,
    "dateOfCreation": "2025-01-20 10:30:00"
  }
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `201 Created`
- Menu cr√©√© avec ID g√©n√©r√©
- Date de cr√©ation automatique
- Plats associ√©s correctement

#### **Sc√©nario CARD-003 : Tentative de cr√©ation par utilisateur non autoris√©**

**Pr√©-√©tat** : Utilisateur connect√© avec r√¥le CUSTOMER

**√âtapes API** :
```http
POST /cards
Authorization: Bearer {token_customer}
Content-Type: application/json

{
  "name": "Menu Non Autoris√©",
  "dishesId": [],
  "isActive": true
}
```

**R√©sultat attendu** :
```json
{
  "statusCode": 403,
  "message": "Forbidden resource",
  "error": "Forbidden"
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `403 Forbidden`
- Aucune cr√©ation effectu√©e
- Message d'erreur s√©curis√©

---

### üõí **TH√àME 3 : Gestion des commandes (Orders)**

#### **Sc√©nario ORDER-001 : Cr√©ation de commande par client**

**Pr√©-√©tat** :
- Utilisateur connect√© avec r√¥le CUSTOMER
- Tables disponibles en base
- Plats disponibles en base

**√âtapes API** :
```http
POST /orders
Authorization: Bearer {token_customer}
Content-Type: application/json

{
  "tableNumberId": "table_id_123",
  "dishes": [
    {
      "dishId": "dish_id_1",
      "isPaid": false
    },
    {
      "dishId": "dish_id_2",
      "isPaid": false
    }
  ],
  "status": "FINISH",
  "totalPrice": 45.50,
  "tips": 5.00
}
```

**R√©sultat attendu** :
```json
{
  "error": "",
  "data": {
    "_id": "order_id_new",
    "tableNumberId": "table_id_123",
    "dishes": [
      {"dishId": "dish_id_1", "isPaid": false},
      {"dishId": "dish_id_2", "isPaid": false}
    ],
    "status": "FINISH",
    "totalPrice": 45.50,
    "tips": 5.00,
    "dateOfCreation": "2025-01-20 12:15:00"
  }
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `201 Created`
- Commande cr√©√©e avec ID g√©n√©r√©
- Calcul total prix correct
- Statut et plats sauvegard√©s

#### **Sc√©nario ORDER-002 : Modification de commande par personnel autoris√©**

**Pr√©-√©tat** :
- Utilisateur connect√© avec r√¥le WAITER
- Commande existante en base

**√âtapes API** :
```http
PUT /orders/{order_id}
Authorization: Bearer {token_waiter}
Content-Type: application/json

{
  "status": "IN_PREPARATION",
  "totalPrice": 50.00
}
```

**R√©sultat attendu** :
```json
{
  "error": "",
  "data": {
    "_id": "order_id",
    "status": "IN_PREPARATION",
    "totalPrice": 50.00,
    "dateLastModified": "2025-01-20 12:20:00",
    "...": "autres_champs_inchang√©s"
  }
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `200 OK`
- Modifications appliqu√©es
- Date de derni√®re modification mise √† jour
- Autres champs pr√©serv√©s

#### **Sc√©nario ORDER-003 : Consultation des commandes (acc√®s libre)**

**Pr√©-√©tat** : Utilisateur connect√© (n'importe quel r√¥le)

**√âtapes API** :
```http
GET /orders
Authorization: Bearer {token}
```

**R√©sultat attendu** :
```json
{
  "error": "",
  "data": [
    {
      "_id": "order1",
      "tableNumberId": "table1",
      "dishes": [...],
      "status": "FINISH",
      "totalPrice": 45.50,
      "dateOfCreation": "..."
    }
  ]
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `200 OK`
- Liste compl√®te des commandes
- Structure OrderResponseDTO respect√©e
- Tri par date d√©croissante

---

### üîí **TH√àME 4 : Contr√¥le d'acc√®s RBAC**

#### **Sc√©nario RBAC-001 : Acc√®s refus√© - Endpoint r√©serv√© aux managers**

**Pr√©-√©tat** : Utilisateur connect√© avec r√¥le CUSTOMER

**√âtapes API** :
```http
POST /dishes
Authorization: Bearer {token_customer}
Content-Type: application/json

{
  "name": "Plat Non Autoris√©",
  "ingredients": [],
  "price": 15.00,
  "description": "Test",
  "category": "MAIN_DISHES",
  "timeCook": 20,
  "isAvailable": true
}
```

**R√©sultat attendu** :
```json
{
  "statusCode": 403,
  "message": "Forbidden resource",
  "error": "Forbidden"
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `403 Forbidden`
- Aucune cr√©ation effectu√©e en base
- Message d'erreur g√©n√©rique (s√©curit√©)

#### **Sc√©nario RBAC-002 : Hi√©rarchie des r√¥les - Admin peut tout faire**

**Pr√©-√©tat** : Utilisateur connect√© avec r√¥le ADMIN

**√âtapes API** :
```http
DELETE /users/{user_id}
Authorization: Bearer {token_admin}
```

**R√©sultat attendu** :
```json
{
  "error": "",
  "data": {
    "deleted": true,
    "message": "User successfully deleted from both Firebase Auth and MongoDB"
  }
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `200 OK`
- Suppression effective (MongoDB + Firebase)
- Confirmation de l'action

#### **Sc√©nario RBAC-003 : Hi√©rarchie des r√¥les - Manager ne peut pas supprimer d'utilisateurs**

**Pr√©-√©tat** : Utilisateur connect√© avec r√¥le MANAGER

**√âtapes API** :
```http
DELETE /users/{user_id}
Authorization: Bearer {token_manager}
```

**R√©sultat attendu** :
```json
{
  "statusCode": 403,
  "message": "Forbidden resource",
  "error": "Forbidden"
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `403 Forbidden`
- Aucune suppression effectu√©e
- Respect hi√©rarchie des permissions

---

### üçΩÔ∏è **TH√àME 5 : Gestion des plats (Dishes)**

#### **Sc√©nario DISH-001 : Consultation des plats (acc√®s libre)**

**Pr√©-√©tat** : Utilisateur connect√©, plats en base via fixtures

**√âtapes API** :
```http
GET /dishes
Authorization: Bearer {token}
```

**R√©sultat attendu** :
```json
{
  "error": "",
  "data": [
    {
      "_id": "dish_id",
      "name": "Spaghetti Carbonara",
      "ingredients": [
        {
          "ingredientId": "ingredient_id",
          "unity": "CENTILITRE",
          "quantity": 200
        }
      ],
      "price": 15.50,
      "description": "P√¢tes italiennes traditionnelles",
      "category": "MAIN_DISHES",
      "timeCook": 15,
      "isAvailable": true,
      "dateOfCreation": "..."
    }
  ]
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `200 OK`
- Structure DishResponseDTO respect√©e
- Ingr√©dients avec quantit√©s
- Cat√©gories valides

#### **Sc√©nario DISH-002 : Cr√©ation de plat par personnel cuisine**

**Pr√©-√©tat** :
- Utilisateur connect√© avec r√¥le KITCHEN_STAFF
- Ingr√©dients disponibles en base

**√âtapes API** :
```http
POST /dishes
Authorization: Bearer {token_kitchen}
Content-Type: application/json

{
  "name": "Salade C√©sar",
  "ingredients": [
    {
      "ingredientId": "ingredient_salade_id",
      "unity": "CENTILITRE",
      "quantity": 100
    }
  ],
  "price": 12.00,
  "description": "Salade fra√Æche avec parmesan",
  "category": "SALADS",
  "timeCook": 10,
  "isAvailable": true
}
```

**R√©sultat attendu** :
```json
{
  "error": "",
  "data": {
    "_id": "new_dish_id",
    "name": "Salade C√©sar",
    "ingredients": [...],
    "price": 12.00,
    "category": "SALADS",
    "timeCook": 10,
    "isAvailable": true,
    "dateOfCreation": "2025-01-20 14:00:00"
  }
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `201 Created`
- Plat cr√©√© avec tous les champs
- Ingr√©dients li√©s correctement
- Cat√©gorie valid√©e selon enum

---

### üì¶ **TH√àME 6 : Gestion des stocks**

#### **Sc√©nario STOCK-001 : Consultation des stocks (acc√®s libre)**

**Pr√©-√©tat** : Utilisateur connect√© avec r√¥le OWNER

**√âtapes API** :
```http
GET /stocks
Authorization: Bearer {token}
```

**R√©sultat attendu** :
```json
{
  "error": "",
  "data": [
    {
      "_id": "stock_id",
      "name": "Stock Principal",
      "ingredients": [
        {
          "ingredientId": "ingredient_id",
          "currentQuantity": 100,
          "minimalQuantity": 10,
          "dateAddedToStock": "2025-01-01",
          "dateLastModified": "2025-01-20"
        }
      ],
      "dateOfCreation": "..."
    }
  ]
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `200 OK`
- Stocks avec quantit√©s actuelles
- Seuils minimums d√©finis
- Dates de tra√ßabilit√©

---

## 4. Sc√©narios transversaux

### **Sc√©nario TRANS-001 : Gestion des erreurs de validation**

**Pr√©-√©tat** : Utilisateur connect√© avec droits suffisants

**√âtapes API** :
```http
POST /dishes
Authorization: Bearer {token_manager}
Content-Type: application/json

{
  "name": "",
  "price": -10,
  "category": "INVALID_CATEGORY"
}
```

**R√©sultat attendu** :
```json
{
  "statusCode": 400,
  "message": [
    "name should not be empty",
    "price must be a positive number",
    "category must be a valid enum value"
  ],
  "error": "Bad Request"
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `400 Bad Request`
- Messages d'erreur d√©taill√©s
- Validation c√¥t√© serveur active

### **Sc√©nario TRANS-002 : Gestion des ressources inexistantes**

**Pr√©-√©tat** : Utilisateur connect√©

**√âtapes API** :
```http
GET /dishes/inexistent_id_123456
Authorization: Bearer {token}
```

**R√©sultat attendu** :
```json
{
  "statusCode": 404,
  "message": "Dish with ID inexistent_id_123456 not found",
  "error": "Not Found"
}
```

**Crit√®res d'acceptation** :
- Code HTTP : `404 Not Found`
- Message explicite avec ID
- Aucune exposition de donn√©es sensibles

### **Sc√©nario TRANS-003 : Performance et temps de r√©ponse**

**Pr√©-√©tat** : Base de donn√©es avec volumes r√©alistes

**√âtapes API** :
```http
GET /dishes
Authorization: Bearer {token}
```

**Crit√®res d'acceptation** :
- Temps de r√©ponse < 2 secondes
- Payload optimis√© (< 1MB)
- Pagination si > 50 √©l√©ments

---

## 5. Tra√ßabilit√© et documentation

### R√©f√©rences techniques
- üìã **[API Reference RBAC](../API_REFERENCE_RBAC.md)** - Documentation compl√®te des endpoints
- üîó **[Documentation Swagger](http://localhost:3000/api)** - Interface interactive pour tests
- üß™ **[Tests unitaires](../HARNESS_TESTS_FINAL_SUMMARY.md)** - 416 tests, 78.21% couverture

### Versions et environnements
- **API Version** : 1.0.0
- **Node.js** : ‚â• 20.0.0
- **MongoDB** : 8.x
- **Firebase** : 12.x

### Suivi des recettes

| Sc√©nario | Statut | Date test | R√©sultat | Commentaires |
|----------|--------|-----------|----------|--------------|
| AUTH-001 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Connexion fonctionnelle |
| AUTH-002 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Erreurs g√©r√©es |
| AUTH-003 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Permissions correctes |
| CARD-001 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Consultation menus OK |
| CARD-002 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Cr√©ation autoris√©e |
| CARD-003 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Acc√®s refus√© correctement |
| ORDER-001 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Commande client OK |
| ORDER-002 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Modification serveur OK |
| ORDER-003 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Consultation globale OK |
| RBAC-001 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Acc√®s refus√© correct |
| RBAC-002 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Admin rights OK |
| RBAC-003 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Manager limites OK |
| DISH-001 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Consultation plats OK |
| DISH-002 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Cr√©ation cuisine OK |
| STOCK-001 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Consultation stocks OK |
| TRANS-001 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Validation erreurs OK |
| TRANS-002 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | 404 g√©r√©s correctement |
| TRANS-003 | ‚úÖ Valid√© | 2025-01-20 | ‚úÖ OK | Performances respect√©es |

---

## 6. Conclusion de la recette

### R√©sultats de validation

**üìä Statistiques globales** :
- **18 sc√©narios test√©s** : 18 valid√©s (100%)
- **Couverture fonctionnelle** : Compl√®te
- **S√©curit√© RBAC** : Valid√©e sur 6 niveaux
- **Performance** : Conforme aux exigences

**‚úÖ Crit√®res de recette atteints** :
- ‚úÖ **Fonctionnel** - Toutes les fonctionnalit√©s op√©rationnelles
- ‚úÖ **S√©curis√©** - Authentification et autorisations robustes
- ‚úÖ **Robuste** - Gestion d'erreurs compl√®te
- ‚úÖ **Performant** - Temps de r√©ponse < 2s respect√©s

### Validation pour mise en production

L'API Eatopia **r√©pond √† tous les crit√®res de recette** et est **valid√©e pour la mise en production**.

Les tests confirment :
- **Conformit√© fonctionnelle** aux sp√©cifications
- **S√©curit√© applicative** renforc√©e (RBAC + Firebase)
- **Robustesse** face aux erreurs et cas limites
- **Performance** adapt√©e √† un usage professionnel
